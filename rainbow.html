<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>彩虹价格图表 — BTC Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="nav.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #13131a; --border: #1e1e2e;
    --gold: #f7b731; --green: #26de81; --red: #fc5c65;
    --blue: #74b9ff; --text: #e8e8f0; --muted: #5a5a7a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; /* overflow-x: hidden; removed for sidebar layout */ }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 999;
  }
  .main { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

  .page-title { margin-bottom: 28px; }
  .page-title h1 { font-size: 30px; font-weight: 800; margin-bottom: 8px; }
  .page-title h1 span { color: var(--gold); }
  .page-title p { font-size: 14px; color: var(--muted); line-height: 1.8; max-width: 720px; }
  .page-title p strong { color: var(--text); }

  /* 当前色带状态 */
  .band-status {
    display: flex; align-items: center; gap: 20px;
    margin-bottom: 24px; flex-wrap: wrap;
  }
  .band-badge {
    display: flex; align-items: center; gap: 12px;
    padding: 16px 24px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    font-family: 'Space Mono', monospace;
  }
  .band-color-dot { width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0; }
  .band-badge-label { font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 3px; }
  .band-badge-value { font-size: 18px; font-weight: 700; }

  /* stats */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; opacity: 0.8; }
  .stat-card.c-gold::before   { background: var(--gold); }
  .stat-card.c-blue::before   { background: var(--blue); }
  .stat-card.c-green::before  { background: var(--green); }
  .stat-card.c-purple::before { background: #a29bfe; }
  .stat-label { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 8px; }
  .stat-value { font-size: 18px; font-weight: 700; font-family: 'Space Mono', monospace; }
  .stat-sub   { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 4px; }

  /* legend */
  .legend-wrap { margin-bottom: 16px; }
  .legend-title { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
  .legend-grid { display: flex; flex-direction: column; gap: 4px; }
  .legend-row-item { display: flex; align-items: center; gap: 10px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }
  .legend-swatch { width: 32px; height: 10px; border-radius: 3px; flex-shrink: 0; }

  /* chart */
  .chart-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; height: 500px; overflow: hidden; }
  .chart-label { font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 16px; }
  #rainbowChart { width: 100%; height: 420px; display: block; }

  /* status */
  .status-bar { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; }
  .status-dot.loading { background: var(--gold); animation: pulse 1s infinite; }
  .status-dot.ready   { background: var(--green); }
  .status-dot.error   { background: var(--red); }
  @keyframes pulse { 0%,100%{ opacity:1; transform:scale(1); } 50%{ opacity:0.4; transform:scale(0.8); } }

  /* note */
  .note { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.9; }
  .note strong { color: var(--text); }

  @media (max-width: 900px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 600px) { .main { padding: 16px 20px; } .stats-grid { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>

<div id="nav-root"></div>

<div class="main">
  <div class="page-title">
    <h1>比特币 <span>彩虹价格图表</span></h1>
    <p>
      原始对数回归曲线由 <strong>Trolololo（2014）</strong> 创建，彩色色带由
      <strong>Reddit用户 azop</strong> 引入，完整版本由 <strong>Über Holger</strong> 完成。
      以 2009年1月9日（创世块）为起点，用对数回归公式生成9条彩虹色带，
      直观显示比特币价格处于历史哪个估值区间。
      这是一个<strong>趣味性长期参考工具</strong>，不具备科学预测能力。
    </p>
  </div>

  <!-- 当前色带状态 -->
  <div class="band-status" id="bandStatus">
    <div class="band-badge" id="currentBandBadge">
      <div class="band-color-dot" id="currentBandDot"></div>
      <div>
        <div class="band-badge-label">当前所在色带</div>
        <div class="band-badge-value" id="currentBandName">计算中...</div>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card c-gold">
      <div class="stat-label">今日价格</div>
      <div class="stat-value" id="s-price" style="color:var(--gold)">--</div>
      <div class="stat-sub">Binance 实时</div>
    </div>
    <div class="stat-card c-blue">
      <div class="stat-label">回归中心线</div>
      <div class="stat-value" id="s-center" style="color:var(--blue)">--</div>
      <div class="stat-sub">今日对数回归值</div>
    </div>
    <div class="stat-card c-green">
      <div class="stat-label">价格 / 中心线</div>
      <div class="stat-value" id="s-ratio" style="color:var(--green)">--</div>
      <div class="stat-sub" id="s-ratio-sub">高于/低于回归中心</div>
    </div>
    <div class="stat-card c-purple">
      <div class="stat-label">色带下沿 / 上沿</div>
      <div class="stat-value" id="s-band-range">--</div>
      <div class="stat-sub" id="s-band-sub">当前色带价格区间</div>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend-wrap">
    <div class="legend-title">彩虹色带含义（从下到上，估值由低到高）</div>
    <div class="legend-grid" id="legendGrid"></div>
  </div>

  <!-- Status -->
  <div class="status-bar">
    <div class="status-dot loading" id="statusDot"></div>
    <span id="statusText">正在加载数据...</span>
  </div>

  <!-- Chart -->
  <div class="chart-wrap">
    <div class="chart-label">比特币彩虹价格图表（对数坐标）</div>
    <canvas id="rainbowChart"></canvas>
  </div>

  <div class="note">
    <strong>公式来源：</strong>
    log₁₀(price) = 2.66167155005961 × ln(距创世块天数) − 17.9183761889864，
    由 Trolololo 于2014年在 Bitcointalk 论坛发布。<br>
    <strong>色带划分：</strong>9条色带通过对中心回归线乘以不同倍数（0.5～16倍）生成，
    每条色带代表不同的市场情绪阶段。<br>
    <strong>数据来源：</strong>历史价格来自 btc_history.csv，今日实时价格来自 Binance API。<br>
    <strong>注意：</strong>此图为趣味性工具，历史上曾多次被突破，不构成投资建议。
  </div>
</div>

<script>
renderNav('rainbow');

var rainbowChart = null;

// ── 创世块日期（比特币第一个区块） ──────────────────
var GENESIS = new Date('2009-01-09');

// ── 9条彩虹色带定义 ──────────────────────────────────
//
// 每条色带有：颜色、标签、相对于回归线的倍数上下界
// 图表从下到上依次填充，形成彩虹效果
//
// 倍数基于 blockchaincenter.net 的公开参数校准
// band_price = 10^(A * ln(days) + B) * multiplier

var BANDS = [
  { label: '最大泡沫区',  color: '#c0392b', bg: 'rgba(192,57,43,0.25)',   mult: 16.0 },
  { label: '泡沫警告',    color: '#e74c3c', bg: 'rgba(231,76,60,0.22)',   mult: 8.0  },
  { label: '准备获利',    color: '#e67e22', bg: 'rgba(230,126,34,0.20)',  mult: 5.0  },
  { label: '开始谨慎',    color: '#f39c12', bg: 'rgba(243,156,18,0.20)',  mult: 3.5  },
  { label: '持有',        color: '#f1c40f', bg: 'rgba(241,196,15,0.18)',  mult: 2.5  },
  { label: '仍然便宜',    color: '#2ecc71', bg: 'rgba(46,204,113,0.18)',  mult: 1.7  },
  { label: '积累',        color: '#1abc9c', bg: 'rgba(26,188,156,0.18)',  mult: 1.2  },
  { label: '买！趁便宜',  color: '#3498db', bg: 'rgba(52,152,219,0.20)',  mult: 0.8  },
  { label: '比特币已死？', color: '#8e44ad', bg: 'rgba(142,68,173,0.22)', mult: 0.5  },
];

// ── 回归公式 ─────────────────────────────────────────
// A = 2.66167155005961, B = -17.9183761889864
// price = 10^(A * ln(daysSinceGenesis) + B)

var A = 2.66167155005961;
var B = -17.9183761889864;

function regressionPrice(date) {
  var days = (date - GENESIS) / (1000 * 60 * 60 * 24);
  if (days <= 0) return null;
  return Math.pow(10, A * Math.log(days) + B);
}

function bandPrice(date, multiplier) {
  var base = regressionPrice(date);
  return base ? base * multiplier : null;
}

// ── 找当前色带 ───────────────────────────────────────
function findCurrentBand(todayPrice, today) {
  var base = regressionPrice(today);
  if (!base) return null;

  // 从最低色带开始往上找，price在哪两条带之间
  for (var i = BANDS.length - 1; i >= 0; i--) {
    var bandTop = base * BANDS[i].mult;
    var bandBot = i < BANDS.length - 1 ? base * BANDS[i + 1].mult : 0;
    if (todayPrice <= bandTop) {
      return {
        band:   BANDS[i],
        index:  i,
        top:    bandTop,
        bottom: bandBot,
      };
    }
  }
  // 超过最高色带
  return { band: BANDS[0], index: 0, top: Infinity, bottom: base * BANDS[1].mult };
}

function setStatus(state, text) {
  document.getElementById('statusDot').className    = 'status-dot ' + state;
  document.getElementById('statusText').textContent = text;
}

// ── 解析CSV ──────────────────────────────────────────
function parseCSV(text) {
  var lines = text.trim().split('\n');
  var days  = [];
  for (var i = 1; i < lines.length; i++) {
    var line  = lines[i].replace('\r', '');
    var cols  = line.split(',');
    var price = parseFloat(cols[1]);
    if (!price) continue;
    days.push({ date: new Date(cols[0]), price: price });
  }
  return days;
}

// ── 渲染图例 ─────────────────────────────────────────
function renderLegend(currentIndex) {
  var grid = document.getElementById('legendGrid');
  var html = '';
  BANDS.forEach(function(b, i) {
    var active = i === currentIndex ? ' style="color:#e8e8f0;font-weight:700"' : '';
    var marker = i === currentIndex ? ' ◀ 当前位置' : '';
    html +=
      '<div class="legend-row-item">' +
        '<div class="legend-swatch" style="background:' + b.color + '"></div>' +
        '<span' + active + '>' + b.label + marker + '</span>' +
      '</div>';
  });
  grid.innerHTML = html;
}

// ── 更新统计卡片 ─────────────────────────────────────
function updateStats(todayPrice, today, currentBand) {
  var base  = regressionPrice(today);
  var ratio = todayPrice / base;

  document.getElementById('s-price').textContent =
    '$' + todayPrice.toLocaleString('en-US', {maximumFractionDigits: 0});
  document.getElementById('s-center').textContent =
    '$' + base.toLocaleString('en-US', {maximumFractionDigits: 0});
  document.getElementById('s-ratio').textContent  = ratio.toFixed(2) + 'x';
  document.getElementById('s-ratio').style.color  = ratio > 1 ? '#fc5c65' : '#26de81';
  document.getElementById('s-ratio-sub').textContent =
    ratio > 1 ? '高于回归中心线' : '低于回归中心线';

  if (currentBand) {
    var lo = currentBand.bottom > 0
      ? '$' + currentBand.bottom.toLocaleString('en-US', {maximumFractionDigits: 0})
      : '以下';
    var hi = isFinite(currentBand.top)
      ? '$' + currentBand.top.toLocaleString('en-US', {maximumFractionDigits: 0})
      : '以上';
    document.getElementById('s-band-range').textContent = lo + ' ~ ' + hi;
    document.getElementById('s-band-range').style.color = currentBand.band.color;
    document.getElementById('s-band-sub').textContent   = currentBand.band.label;

    // 更新色带徽章
    var badge = document.getElementById('currentBandBadge');
    badge.style.background   = currentBand.band.bg;
    badge.style.borderColor  = currentBand.band.color + '50';
    document.getElementById('currentBandDot').style.background = currentBand.band.color;
    document.getElementById('currentBandName').textContent     = currentBand.band.label;
    document.getElementById('currentBandName').style.color     = currentBand.band.color;
  }
}

// ── 画图 ─────────────────────────────────────────────
//
// 图层从下到上：
//   1. 9条彩虹色带（填充区域，从最低倍数到最高倍数）
//   2. BTC 历史价格线（金色）

function drawChart(days, todayPrice) {
  // 扩展日期范围到2030年（预测用）
  var today   = new Date();
  var future  = new Date('2030-01-01');
  var allDates = days.map(function(d) { return d.date; });
  // 加入未来日期点（每季度一个）
  var cur = new Date(today);
  while (cur <= future) {
    allDates.push(new Date(cur));
    cur.setMonth(cur.getMonth() + 3);
  }

  // 构建价格折线数据
  var priceData = days.map(function(d) { return { x: d.date, y: d.price }; });

  // 构建每条彩虹色带数据
  // Chart.js 填充：每条带的上沿线，下一条带是下一个dataset，fill:'+1' 填充到下一条
  // 顺序：最高带 → 最低带（这样填充颜色正确）
  var bandDatasets = [];

  // 先加最高色带的上边界（用透明线）
  var topLineData = allDates.map(function(d) {
    return { x: d, y: bandPrice(d, BANDS[0].mult * 2) };
  });
  bandDatasets.push({
    label:           '__top__',
    data:            topLineData,
    borderColor:     'transparent',
    backgroundColor: 'transparent',
    borderWidth:     0,
    pointRadius:     0,
    fill:            '+1',
    tension:         0.2,
    yAxisID:         'y',
    order:           50,
  });

  // 每条色带：从高到低
  BANDS.forEach(function(band, i) {
    var lineData = allDates.map(function(d) {
      return { x: d, y: bandPrice(d, band.mult) };
    });
    bandDatasets.push({
      label:           i === 0 ? band.label : band.label,
      data:            lineData,
      borderColor:     band.color + '80',
      backgroundColor: band.bg,
      borderWidth:     0.8,
      pointRadius:     0,
      fill:            '+1',
      tension:         0.2,
      yAxisID:         'y',
      order:           50 + i + 1,
    });
  });

  // 最低色带下边界（用于最后一条fill的底部）
  var bottomLineData = allDates.map(function(d) {
    return { x: d, y: bandPrice(d, BANDS[BANDS.length - 1].mult * 0.3) };
  });
  bandDatasets.push({
    label:           '__bottom__',
    data:            bottomLineData,
    borderColor:     'transparent',
    backgroundColor: 'transparent',
    borderWidth:     0,
    pointRadius:     0,
    fill:            false,
    tension:         0.2,
    yAxisID:         'y',
    order:           60,
  });

  // BTC价格线（最后加，order最小，显示在最上层）
  var priceLine = {
    label:           'BTC 价格',
    data:            priceData,
    borderColor:     '#ffffff',
    backgroundColor: 'transparent',
    borderWidth:     2,
    pointRadius:     0,
    tension:         0.15,
    fill:            false,
    yAxisID:         'y',
    order:           1,
  };

  var allDatasets = bandDatasets.concat([priceLine]);

  if (rainbowChart) rainbowChart.destroy();

  var ctx = document.getElementById('rainbowChart').getContext('2d');
  rainbowChart = new Chart(ctx, {
    type: 'line',
    data: { datasets: allDatasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: false,  // 色带太多，用自定义图例代替
        },
        tooltip: {
          backgroundColor: '#13131a',
          borderColor: '#1e1e2e',
          borderWidth: 1,
          titleColor: '#5a5a7a',
          bodyColor: '#e8e8f0',
          filter: function(item) {
            // 只显示价格线的tooltip，色带线不显示
            return item.dataset.label === 'BTC 价格';
          },
          callbacks: {
            title: function(items) {
              return new Date(items[0].parsed.x).toLocaleDateString('zh-CN');
            },
            label: function(ctx) {
              return ' BTC 价格: $' + ctx.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year' },
          ticks: { color: '#5a5a7a', font: { family: 'Space Mono, monospace' } },
          grid:  { color: '#1e1e2e' },
        },
        y: {
          type: 'logarithmic',
          position: 'right',
          min: 0.01,
          ticks: {
            color: '#5a5a7a',
            font: { family: 'Space Mono, monospace' },
            callback: function(v) {
              var neat = [0.1, 1, 10, 100, 1000, 10000, 100000, 1000000];
              return neat.indexOf(v) >= 0 ? '$' + v.toLocaleString() : '';
            }
          },
          grid: { color: '#1e1e2e' },
        }
      }
    }
  });
}

// ── 主流程 ──────────────────────────────────────────
Promise.all([
  fetch('https://caroljx.github.io/btc-dashboard/btc_history.csv')
    .then(function(r) { return r.text(); }),
  fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT')
    .then(function(r) { return r.json(); })
])
.then(function(results) {
  var days       = parseCSV(results[0]);
  var todayPrice = parseFloat(results[1].price);
  var today      = new Date();

  if (!days.length || !todayPrice) {
    setStatus('error', '❌ 数据解析失败');
    return;
  }

  var currentBand = findCurrentBand(todayPrice, today);

  setStatus('ready',
    '✅ 计算完成 — 共 ' + days.length + ' 天数据 | ' +
    '今日价格 $' + todayPrice.toLocaleString('en-US', {maximumFractionDigits: 0}) + ' | ' +
    '当前色带：' + (currentBand ? currentBand.band.label : '--')
  );

  updateStats(todayPrice, today, currentBand);
  renderLegend(currentBand ? currentBand.index : -1);
  drawChart(days, todayPrice);
})
.catch(function(err) {
  setStatus('error', '❌ 加载失败：' + err.message);
});
</script>
</body>
</html>
