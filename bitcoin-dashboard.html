<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<script src="nav.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #1e1e2e;
    --gold: #f7b731;
    --gold-dim: #a07820;
    --green: #26de81;
    --red: #fc5c65;
    --purple: #a29bfe;
    --text: #e8e8f0;
    --muted: #5a5a7a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    /* overflow-x: hidden; removed for sidebar layout */
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 999;
  }

  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 24px 40px; border-bottom: 1px solid var(--border);
  }

  .logo { display: flex; align-items: center; gap: 12px; }

  .btc-icon {
    width: 40px; height: 40px; background: var(--gold);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-weight: 800; color: #000; font-size: 18px;
    box-shadow: 0 0 20px rgba(247,183,49,0.4);
  }

  .logo-text { font-size: 20px; font-weight: 800; letter-spacing: 0.05em; }
  .logo-text span { color: var(--gold); }

  .live-badge {
    display: flex; align-items: center; gap: 6px;
    font-family: 'Space Mono', monospace; font-size: 11px;
    color: var(--green); border: 1px solid var(--green);
    padding: 4px 10px; border-radius: 20px;
  }

  .live-dot {
    width: 6px; height: 6px;
    background: var(--green); border-radius: 50%;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  .main { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

  /* â”€â”€ Price Hero â”€â”€ */
  .price-hero {
    display: grid; grid-template-columns: 1fr auto;
    gap: 24px; margin-bottom: 32px; align-items: end;
  }

  .price-label {
    font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 8px; font-family: 'Space Mono', monospace;
  }

  .price-big {
    font-size: clamp(42px, 6vw, 72px); font-weight: 800; line-height: 1;
    color: var(--gold); text-shadow: 0 0 40px rgba(247,183,49,0.3);
    font-family: 'Space Mono', monospace;
  }

  .price-change {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700;
    margin-top: 10px; padding: 6px 14px; border-radius: 6px;
  }
  .price-change.up   { background: rgba(38,222,129,0.12); color: var(--green); }
  .price-change.down { background: rgba(252,92,101,0.12); color: var(--red); }

  /* â”€â”€ Stats â”€â”€ */
  .stats-row {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 16px; margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px;
    position: relative; overflow: hidden; transition: border-color 0.2s;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--gold), transparent); opacity: 0.5;
  }
  .stat-card:hover { border-color: var(--gold-dim); }
  .stat-label {
    font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 8px;
  }
  .stat-value { font-size: 22px; font-weight: 700; font-family: 'Space Mono', monospace; }

  /* â”€â”€ Tab Nav â”€â”€ */
  .tab-nav {
    display: flex; border-bottom: 1px solid var(--border); margin-bottom: 32px;
  }
  .tab-btn {
    background: none; border: none; border-bottom: 2px solid transparent;
    color: var(--muted); font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.08em;
    padding: 12px 28px; cursor: pointer; transition: all 0.2s;
    margin-bottom: -1px;
  }
  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* â”€â”€ K-line tab â”€â”€ */
  .chart-header {
    display: flex; align-items: center;
    justify-content: space-between; margin-bottom: 16px;
  }
  .chart-title {
    font-size: 14px; font-weight: 700;
    letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted);
  }
  .tf-group {
    display: flex; gap: 4px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 4px;
  }
  .tf-btn {
    background: none; border: none; color: var(--muted);
    font-family: 'Space Mono', monospace; font-size: 12px;
    padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.15s;
  }
  .tf-btn:hover { color: var(--text); }
  .tf-btn.active { background: var(--gold); color: #000; font-weight: 700; }

  .chart-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden;
  }
  #klineChart { width: 100%; height: 420px; display: block; }

  /* â”€â”€ CVDD tab â”€â”€ */
  .cvdd-intro { margin-bottom: 24px; }
  .cvdd-intro h2 { font-size: 22px; font-weight: 800; margin-bottom: 10px; }
  .cvdd-intro p { font-size: 14px; color: var(--muted); line-height: 1.8; max-width: 680px; }
  .cvdd-intro strong { color: var(--gold); }

  /* CVDD stats cards */
  .cvdd-stats {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 12px; margin-bottom: 24px;
  }
  .cvdd-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px; position: relative; overflow: hidden;
  }
  .cvdd-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    opacity: 0.6;
  }
  .cvdd-card.gold-accent::before  { background: var(--gold); }
  .cvdd-card.green-accent::before { background: var(--green); }
  .cvdd-card.purple-accent::before { background: var(--purple); }
  .cvdd-card.muted-accent::before { background: var(--muted); }

  .cvdd-card .stat-label {
    font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 8px;
  }
  .cvdd-card .stat-value {
    font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace;
  }
  .cvdd-card .stat-sub {
    font-size: 11px; color: var(--muted);
    font-family: 'Space Mono', monospace; margin-top: 4px;
  }

  /* CVDD chart wrap */
  .cvdd-chart-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; margin-bottom: 16px;
  }
  #cvddChart { width: 100%; height: 460px; display: block; }

  /* CVDD status bar */
  .cvdd-status {
    font-family: 'Space Mono', monospace; font-size: 12px;
    color: var(--muted); margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .cvdd-status-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--muted);
  }
  .cvdd-status-dot.loading { background: var(--gold); animation: pulse 1s infinite; }
  .cvdd-status-dot.ready   { background: var(--green); }
  .cvdd-status-dot.error   { background: var(--red); }

  /* Bottom notes */
  .cvdd-note {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 20px;
    font-family: 'Space Mono', monospace; font-size: 11px;
    color: var(--muted); line-height: 1.9;
  }
  .cvdd-note strong { color: var(--text); }

  @media (max-width: 900px) {
    .cvdd-stats { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 768px) {
    header, .main { padding: 16px 20px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .price-hero { grid-template-columns: 1fr; }
    .price-big { font-size: 40px; }
    .cvdd-stats { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div id="nav-root"></div>

<div class="main">

  <!-- Price Hero -->
  <div class="price-hero">
    <div>
      <div class="price-label">Bitcoin / USD &middot; æ¯åˆ†é’Ÿåˆ·æ–°</div>
      <div class="price-big" id="priceDisplay">åŠ è½½ä¸­...</div>
      <div class="price-change up" id="changeDisplay">-- --</div>
    </div>
    <div style="text-align:right">
      <div class="price-label">æœ€åæ›´æ–°</div>
      <div style="font-family:'Space Mono',monospace;font-size:13px;color:var(--muted)" id="lastUpdate">--</div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">24h æœ€é«˜</div>
      <div class="stat-value" id="high24h">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">24h æœ€ä½</div>
      <div class="stat-value" id="low24h">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">24h æˆäº¤é‡</div>
      <div class="stat-value" id="vol24h">--</div>
    </div>
  </div>

  <!-- Tab Nav -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('kline', this)">K çº¿å›¾</button>
    <button class="tab-btn" onclick="switchTab('cvdd', this)">CVDD æŒ‡æ ‡</button>
  </div>

  <!-- Tab: K-line -->
  <div class="tab-panel active" id="tab-kline">
    <div class="chart-header">
      <div class="chart-title">å†å² K çº¿</div>
      <div class="tf-group">
        <button class="tf-btn" onclick="loadKline('1d', event)">1å¤©</button>
        <button class="tf-btn active" onclick="loadKline('1w', event)">1å‘¨</button>
        <button class="tf-btn" onclick="loadKline('1m', event)">1æœˆ</button>
        <button class="tf-btn" onclick="loadKline('3m', event)">3æœˆ</button>
      </div>
    </div>
    <div class="chart-wrap">
      <canvas id="klineChart"></canvas>
    </div>
  </div>

  <!-- Tab: CVDD -->
  <div class="tab-panel" id="tab-cvdd">

    <div class="cvdd-intro">
      <h2>è¿‘ä¼¼ CVDD &mdash; ç´¯è®¡ä»·å€¼å¤©æ•°é”€æ¯</h2>
      <p>
        ç”±é“¾ä¸Šåˆ†æå¸ˆ <strong>Willy Woo</strong> åˆ›å»ºçš„åº•éƒ¨åˆ¤æ–­æŒ‡æ ‡ã€‚
        æœ¬é¡µå›¾è¡¨ä½¿ç”¨ <strong>CoinGecko å…¬å¼€æ•°æ® + æœ¬åœ°CSV</strong> è‡ªè¡Œè®¡ç®—ï¼Œ
        æ•°æ®å®Œå…¨é€æ˜ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹å›¾è¡¨æœåŠ¡ã€‚
        å†å²ä¸Š CVDD æ›¾å¤šæ¬¡è§¦ç¢°æ¯”ç‰¹å¸<strong>å‘¨æœŸåº•éƒ¨</strong>ï¼Œå¯ä½œä¸ºé•¿çº¿å‚è€ƒã€‚
      </p>
    </div>

    <!-- CVDD stat cards -->
    <div class="cvdd-stats">
      <div class="cvdd-card gold-accent">
        <div class="stat-label">å½“å‰ BTC ä»·æ ¼</div>
        <div class="stat-value" id="cvdd-price" style="color:var(--gold)">--</div>
      </div>
      <div class="cvdd-card green-accent">
        <div class="stat-label">è¿‘ä¼¼ CVDD</div>
        <div class="stat-value" id="cvdd-value" style="color:var(--green)">--</div>
        <div class="stat-sub">åº•éƒ¨å‚è€ƒçº¿</div>
      </div>
      <div class="cvdd-card purple-accent">
        <div class="stat-label">ä»·æ ¼ / CVDD æ¯”å€¼</div>
        <div class="stat-value" id="cvdd-ratio" style="color:var(--purple)">--</div>
        <div class="stat-sub" id="cvdd-interp">--</div>
      </div>
      <div class="cvdd-card muted-accent">
        <div class="stat-label">æ•°æ®è¦†ç›–</div>
        <div class="stat-value" id="cvdd-days" style="font-size:16px;color:var(--text)">--</div>
        <div class="stat-sub" id="cvdd-range">--</div>
      </div>
    </div>

    <!-- Status -->
    <div class="cvdd-status">
      <div class="cvdd-status-dot loading" id="cvddDot"></div>
      <span id="cvddStatus">æ­£åœ¨åŠ è½½ CSV + API æ•°æ®...</span>
    </div>

    <!-- Chart -->
    <div class="cvdd-chart-wrap">
      <canvas id="cvddChart"></canvas>
    </div>

    <!-- Notes -->
    <div class="cvdd-note">
      <strong>æ•°æ®æ¥æºï¼š</strong>å†å²éƒ¨åˆ†æ¥è‡ªæœ¬åœ° btc_history.csvï¼ˆCoinGecko ä¸‹è½½ï¼‰ï¼Œ
      è¿‘ä¸€å¹´æ•°æ®ç”± CoinGecko API å®æ—¶è¡¥å……ï¼Œä¸¤è€…è‡ªåŠ¨åˆå¹¶å»é‡ã€‚<br>
      <strong>è®¡ç®—æ–¹æ³•ï¼š</strong>å¯¹æ•°æ ‡å‡†åŒ–æˆäº¤é‡ &times; å½“æ—¥ä»·æ ¼ï¼Œç´¯è®¡æ±‚å’Œåé™¤ä»¥å¤©æ•°ï¼Œä¹˜ä»¥æ ¡å‡†ç³»æ•° 2.02ã€‚<br>
      <strong>ä¹°å…¥å‚è€ƒåŒºé—´ï¼š</strong>é»„è‰²ä¸Šæ²¿ = CVDD &times; 1.7ï¼Œç»¿è‰²ä¸‹æ²¿ = CVDD &times; 1.0ã€‚
      ç³»æ•°æ¥è‡ªå››ä¸ªå†å²åº•éƒ¨ï¼ˆ2015 / 2018 / 2020 / 2022ï¼‰çš„å®æµ‹æ¯”å€¼ï¼Œè¿›å…¥åŒºé—´ä¸ä»£è¡¨ç«‹å³åå¼¹ï¼Œå»ºè®®åˆ†æ‰¹æ“ä½œã€‚<br>
      <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯è¿‘ä¼¼ç®—æ³•ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
    </div>

  </div>

</div><!-- /.main -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å…±ç”¨çŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var klineChart = null;
var cvddChart  = null;
var activeTf   = '1w';
var secondsLeft = 60;
var CVDD_SMOOTH = 2.02;  // ç»è¿‡å†å²åº•éƒ¨æ ¡å‡†çš„ç³»æ•°

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  æ ‡ç­¾åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b)  { b.classList.remove('active'); });
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  K çº¿å›¾
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initKline() {
  var ctx = document.getElementById('klineChart').getContext('2d');
  klineChart = new Chart(ctx, {
    type: 'candlestick',
    data: { datasets: [{
      label: 'BTC/USDT',
      data: [],
      color:       { up: '#26de81', down: '#fc5c65', unchanged: '#5a5a7a' },
      borderColor: { up: '#26de81', down: '#fc5c65', unchanged: '#5a5a7a' },
    }]},
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: 16 },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              var d = ctx.raw;
              return ['å¼€: $'+d.o.toLocaleString(), 'é«˜: $'+d.h.toLocaleString(),
                      'ä½: $'+d.l.toLocaleString(), 'æ”¶: $'+d.c.toLocaleString()];
            }
          }
        }
      },
      scales: {
        x: { type: 'timeseries', ticks: { color: '#5a5a7a', maxTicksLimit: 8 }, grid: { color: '#1e1e2e' } },
        y: { position: 'right',
             ticks: { color: '#5a5a7a', callback: function(v) { return '$'+v.toLocaleString(); } },
             grid: { color: '#1e1e2e' } }
      }
    }
  });
}

var TF_MAP = {
  '1d': { interval: '1h',  limit: 24 },
  '1w': { interval: '4h',  limit: 42 },
  '1m': { interval: '1d',  limit: 30 },
  '3m': { interval: '1d',  limit: 90 },
};

function loadKline(tf, e) {
  activeTf = tf;
  document.querySelectorAll('.tf-btn').forEach(function(b) { b.classList.remove('active'); });
  if (e && e.target) e.target.classList.add('active');
  var cfg = TF_MAP[tf];
  fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval='+cfg.interval+'&limit='+cfg.limit)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      klineChart.data.datasets[0].data = data.map(function(d) {
        return { x: parseFloat(d[0]), o: parseFloat(d[1]), h: parseFloat(d[2]),
                 l: parseFloat(d[3]), c: parseFloat(d[4]) };
      });
      klineChart.update();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å®æ—¶ä»·æ ¼ï¼ˆBinanceï¼Œæ¯60ç§’ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fetchPrice() {
  fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var price  = parseFloat(d.lastPrice);
      var change = parseFloat(d.priceChangePercent);
      var isUp   = change >= 0;

      document.getElementById('priceDisplay').textContent =
        '$' + price.toLocaleString('en-US', { maximumFractionDigits: 2 });

      var el = document.getElementById('changeDisplay');
      el.innerHTML   = (isUp ? '&#9650; +' : '&#9660; ') + change.toFixed(2) + '%';
      el.className   = 'price-change ' + (isUp ? 'up' : 'down');

      document.getElementById('high24h').textContent =
        '$' + parseFloat(d.highPrice).toLocaleString('en-US', { maximumFractionDigits: 0 });
      document.getElementById('low24h').textContent =
        '$' + parseFloat(d.lowPrice).toLocaleString('en-US', { maximumFractionDigits: 0 });

      var vol = parseFloat(d.quoteVolume);
      document.getElementById('vol24h').textContent =
        vol > 1e9 ? (vol/1e9).toFixed(2)+'B' : (vol/1e6).toFixed(0)+'M';

      document.getElementById('lastUpdate').textContent =
        new Date().toLocaleTimeString('zh-CN');

      secondsLeft = 60;
    })
    .catch(function() {
      document.getElementById('priceDisplay').textContent = 'è·å–å¤±è´¥';
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CVDD è®¡ç®—æ¨¡å—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ—¥æœŸå¯¹è±¡ â†’ "YYYY-MM-DD" å­—ç¬¦ä¸²ï¼Œç”¨äºå»é‡
function toDateStr(d) {
  return d.toISOString().substring(0, 10);
}

// è§£æ CoinGecko ä¸‹è½½çš„ CSV æ–‡æœ¬
function parseCSV(text) {
  var lines  = text.trim().split('\n');
  var result = [];
  for (var i = 1; i < lines.length; i++) {
    var cols   = lines[i].split(',');
    var price  = parseFloat(cols[1]);
    var volume = parseFloat(cols[3]);
    if (!price || !volume || volume === 0) continue;
    result.push({
      dateStr: cols[0].substring(0, 10),
      date:    new Date(cols[0]),
      price:   price,
      volume:  volume,
    });
  }
  return result;
}

// è§£æ CoinGecko API è¿”å›çš„ JSON
function parseAPI(data) {
  var prices  = data.prices;
  var volumes = data.total_volumes;
  var result  = [];
  for (var i = 0; i < prices.length; i++) {
    var price  = prices[i][1];
    var volume = volumes[i][1];
    if (!price || !volume || volume === 0) continue;
    var d = new Date(prices[i][0]);
    result.push({
      dateStr: toDateStr(d),
      date:    d,
      price:   price,
      volume:  volume,
    });
  }
  return result;
}

// åˆå¹¶ CSVï¼ˆå†å²ï¼‰å’Œ APIï¼ˆè¿‘ä¸€å¹´ï¼‰ï¼Œå»æ‰é‡å æ—¥æœŸï¼ŒæŒ‰æ—¶é—´æ’åº
function mergeAndSort(csvDays, apiDays) {
  var apiDates = {};
  apiDays.forEach(function(d) { apiDates[d.dateStr] = true; });
  var csvOnly = csvDays.filter(function(d) { return !apiDates[d.dateStr]; });
  var merged  = csvOnly.concat(apiDays);
  merged.sort(function(a, b) { return a.date - b.date; });
  return merged;
}

// æ ¸å¿ƒè®¡ç®—ï¼šå¯¹æ•°æ ‡å‡†åŒ– â†’ ç´¯è®¡åŠ æƒ â†’ CVDD
function calcCVDD(days) {
  // 1. æ¯å¤©BTCæˆäº¤é‡ = æˆäº¤é¢(USD) / ä»·æ ¼
  for (var i = 0; i < days.length; i++) {
    days[i].btcVol = days[i].volume / days[i].price;
    days[i].logVol = Math.log(days[i].btcVol);
  }
  // 2. æ‰¾å…¨å±€æœ€å¤§æœ€å°ï¼Œç”¨äºæ ‡å‡†åŒ–
  var minLog = Infinity, maxLog = -Infinity;
  for (var i = 0; i < days.length; i++) {
    if (days[i].logVol < minLog) minLog = days[i].logVol;
    if (days[i].logVol > maxLog) maxLog = days[i].logVol;
  }
  // 3. æ ‡å‡†åŒ– + ç´¯è®¡æ±‚å’Œ + ä¹˜ç³»æ•°
  var cumulative = 0;
  for (var i = 0; i < days.length; i++) {
    var norm       = (days[i].logVol - minLog) / (maxLog - minLog);
    cumulative    += norm * days[i].price;
    days[i].cvdd   = (cumulative / (i + 1)) * CVDD_SMOOTH;
  }
  return days;
}

// æ›´æ–° CVDD ç»Ÿè®¡å¡ç‰‡
function updateCvddStats(days) {
  var latest = days[days.length - 1];
  var ratio  = latest.price / latest.cvdd;

  var interp = ratio < 1.5 ? 'ğŸŸ¢ æ¥è¿‘å†å²åº•éƒ¨'
             : ratio < 3.0 ? 'ğŸŸ¡ å¤„äºä¸­é—´åŒºé—´'
             : ratio < 6.0 ? 'ğŸŸ  é«˜äºåº•éƒ¨å‚è€ƒçº¿'
             :                'ğŸ”´ æ˜æ˜¾é«˜äºåº•éƒ¨å‚è€ƒçº¿';

  document.getElementById('cvdd-price').textContent =
    '$' + latest.price.toLocaleString('en-US', { maximumFractionDigits: 0 });
  document.getElementById('cvdd-value').textContent =
    '$' + latest.cvdd.toLocaleString('en-US', { maximumFractionDigits: 0 });
  document.getElementById('cvdd-ratio').textContent  = ratio.toFixed(2) + 'x';
  document.getElementById('cvdd-interp').textContent = interp;
  document.getElementById('cvdd-days').textContent   = days.length + ' å¤©';
  document.getElementById('cvdd-range').textContent  =
    days[0].date.getFullYear() + ' â†’ ' + latest.date.getFullYear();
}

// å†å²å‘¨æœŸåº•éƒ¨å®šä¹‰
// æ¯ä¸ªåº•éƒ¨æœ‰ï¼šæ—¥æœŸã€å½“æ—¶ä»·æ ¼ã€æ˜¾ç¤ºæ ‡ç­¾
var BOTTOMS = [
  { date: '2015-01-14', price: 170,   label: '2015 åº•éƒ¨\n$170'   },
  { date: '2018-12-15', price: 3200,  label: '2018 åº•éƒ¨\n$3,200' },
  { date: '2020-03-13', price: 4000,  label: '2020 åº•éƒ¨\n$4,000' },
  { date: '2022-11-21', price: 15500, label: '2022 åº•éƒ¨\n$15,500'},
];

// ç”» CVDD å›¾è¡¨ï¼ˆå«åº•éƒ¨æ ‡æ³¨ï¼‰
function drawCvddChart(days) {
  var priceData = days.map(function(d) { return { x: d.date, y: Math.round(d.price) }; });
  var cvddData  = days.map(function(d) { return { x: d.date, y: Math.round(d.cvdd)  }; });

  if (cvddChart) cvddChart.destroy();

  // â”€â”€ æ„å»ºåº•éƒ¨æ ‡æ³¨å¯¹è±¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ¯ä¸ªåº•éƒ¨ç”»ä¸¤ä¸ªå…ƒç´ ï¼š
  //   1. å‚ç›´çº¿ï¼ˆlineï¼‰ï¼šæ ‡å‡ºé‚£å¤©çš„ä½ç½®
  //   2. åœ†ç‚¹ï¼ˆpointï¼‰ï¼šæ ‡åœ¨ä»·æ ¼æ›²çº¿ä¸Š
  //   3. æ–‡å­—æ ‡ç­¾ï¼ˆlabelï¼‰ï¼šæ˜¾ç¤ºåº•éƒ¨åç§°å’Œä»·æ ¼
  var annotations = {};

  BOTTOMS.forEach(function(b, i) {
    var ts = new Date(b.date).getTime();

    // å‚ç›´è™šçº¿
    annotations['line' + i] = {
      type: 'line',
      xMin: ts,
      xMax: ts,
      borderColor: 'rgba(252, 92, 101, 0.5)',  // åŠé€æ˜çº¢è‰²
      borderWidth: 1,
      borderDash: [4, 4],
    };

    // åœ†ç‚¹æ ‡è®°ï¼ˆæ ‡åœ¨åº•éƒ¨ä»·æ ¼ä½ç½®ï¼‰
    annotations['point' + i] = {
      type: 'point',
      xValue: ts,
      yValue: b.price,
      backgroundColor: '#fc5c65',
      borderColor: '#fff',
      borderWidth: 1.5,
      radius: 5,
    };

    // æ–‡å­—æ ‡ç­¾ï¼ˆæ˜¾ç¤ºåœ¨çº¿çš„é¡¶éƒ¨ï¼‰
    // yAdjust è®©æ ‡ç­¾é”™å¼€ï¼Œé¿å…å››ä¸ªæ ‡ç­¾é‡å 
    var yAdjust = (i % 2 === 0) ? -48 : -80;
    annotations['label' + i] = {
      type: 'label',
      xValue: ts,
      yValue: b.price,
      content: b.label.split('\n'),   // æ”¯æŒæ¢è¡Œ
      color: '#fc5c65',
      font: { family: 'Space Mono, monospace', size: 10, weight: 'bold' },
      textAlign: 'center',
      yAdjust: yAdjust,
      callout: {
        enabled: true,
        borderColor: 'rgba(252, 92, 101, 0.4)',
        borderWidth: 1,
      },
    };
  });

  var ctx = document.getElementById('cvddChart').getContext('2d');
  cvddChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'BTC ä»·æ ¼',
          data: priceData,
          borderColor: '#f7b731',
          backgroundColor: 'rgba(247,183,49,0.05)',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.1,
          fill: false,
          yAxisID: 'y',
        },
        {
          label: 'è¿‘ä¼¼ CVDDï¼ˆåº•éƒ¨å‚è€ƒï¼‰',
          data: cvddData,
          borderColor: '#26de81',
          backgroundColor: 'rgba(38,222,129,0.08)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.3,
          borderDash: [6, 3],
          fill: false,
          yAxisID: 'y',
        },
        {
          // ä¸Šè¾¹ç•Œ = CVDD Ã— 1.7
          // å«ä¹‰ï¼šå†å²ä¸Šä»·æ ¼è§¦åº•æ—¶æœ€é«˜ä¹Ÿä¸è¶…è¿‡CVDDçš„1.7å€
          // è¿›å…¥è¿™æ¡çº¿ä»¥ä¸‹ï¼Œè¯´æ˜ä»·æ ¼å·²è¿›å…¥å†å²åº•éƒ¨åŒºé—´
          label: 'ä¹°å…¥åŒºé—´ä¸Šæ²¿ï¼ˆCVDD Ã— 1.7ï¼‰',
          data: days.map(function(d) { return { x: d.date, y: Math.round(d.cvdd * 1.7) }; }),
          borderColor: 'rgba(252, 185, 0, 0.6)',
          backgroundColor: 'rgba(252, 185, 0, 0.07)',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.3,
          borderDash: [3, 3],
          // fill: '+1 è¡¨ç¤ºå¡«å……åˆ°ä¸‹ä¸€ä¸ªæ•°æ®é›†ï¼ˆä¸‹è¾¹ç•Œï¼‰ï¼Œå½¢æˆè‰²å¸¦
          fill: '+1',
          yAxisID: 'y',
        },
        {
          // ä¸‹è¾¹ç•Œ = CVDD Ã— 1.0
          // å«ä¹‰ï¼šå†å²ä¸Šä»·æ ¼æœ€æç«¯æ—¶æ¥è¿‘CVDDæœ¬èº«
          // è·Œåˆ°è¿™é‡Œæ˜¯æåº¦ä½ä¼°ï¼Œå†å²ä¸Šæä¸ºç½•è§
          label: 'ä¹°å…¥åŒºé—´ä¸‹æ²¿ï¼ˆCVDD Ã— 1.0ï¼‰',
          data: days.map(function(d) { return { x: d.date, y: Math.round(d.cvdd * 1.0) }; }),
          borderColor: 'rgba(38, 222, 129, 0.4)',
          backgroundColor: 'rgba(38, 222, 129, 0.07)',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.3,
          borderDash: [3, 3],
          fill: false,
          yAxisID: 'y',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: {
            color: '#e8e8f0',
            font: { family: 'Space Mono, monospace', size: 12 },
            boxWidth: 24, padding: 20,
          }
        },
        tooltip: {
          backgroundColor: '#13131a',
          borderColor: '#1e1e2e',
          borderWidth: 1,
          titleColor: '#5a5a7a',
          bodyColor: '#e8e8f0',
          callbacks: {
            title: function(items) {
              return new Date(items[0].parsed.x).toLocaleDateString('zh-CN');
            },
            label: function(ctx) {
              // åªæ˜¾ç¤ºä»·æ ¼å’ŒCVDDä¸¤æ¡ä¸»çº¿ï¼Œè¾¹ç•Œçº¿åœ¨tooltipé‡Œè·³è¿‡
              if (ctx.datasetIndex === 2 || ctx.datasetIndex === 3) return null;
              return ' ' + ctx.dataset.label + ': $' + ctx.parsed.y.toLocaleString();
            }
          }
        },
        // æŠŠæˆ‘ä»¬æ„å»ºå¥½çš„æ ‡æ³¨å¯¹è±¡ä¼ è¿›å»
        annotation: { annotations: annotations }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year' },
          ticks: { color: '#5a5a7a', font: { family: 'Space Mono, monospace' } },
          grid:  { color: '#1e1e2e' },
        },
        y: {
          type: 'logarithmic',
          position: 'right',
          ticks: {
            color: '#5a5a7a',
            font: { family: 'Space Mono, monospace' },
            callback: function(v) {
              var neat = [100, 500, 1000, 5000, 10000, 50000, 100000];
              return neat.indexOf(v) >= 0 ? '$' + v.toLocaleString() : '';
            }
          },
          grid: { color: '#1e1e2e' },
        }
      }
    }
  });
}

// ä¸»å‡½æ•°ï¼šåŒæ—¶è¯·æ±‚ CSV å’Œ APIï¼Œåˆå¹¶åè®¡ç®—å¹¶ç”»å›¾
function loadCVDD() {
  var dot    = document.getElementById('cvddDot');
  var status = document.getElementById('cvddStatus');

  dot.className    = 'cvdd-status-dot loading';
  status.textContent = 'æ­£åœ¨åŠ è½½ CSV + API æ•°æ®...';

  Promise.all([
    fetch('btc_history.csv').then(function(r) { return r.text(); }),
    fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365&interval=daily')
      .then(function(r) { return r.json(); })
  ])
  .then(function(results) {
    status.textContent = 'è®¡ç®— CVDD ä¸­...';

    var csvDays = parseCSV(results[0]);
    var apiDays = parseAPI(results[1]);
    var merged  = mergeAndSort(csvDays, apiDays);
    var days    = calcCVDD(merged);

    dot.className      = 'cvdd-status-dot ready';
    status.textContent = 'âœ… æ•°æ®å°±ç»ª â€” CSV ' + csvDays.length + ' å¤© + API ' + apiDays.length + ' å¤©ï¼Œåˆå¹¶åå…± ' + days.length + ' å¤©';

    updateCvddStats(days);
    drawCvddChart(days);
  })
  .catch(function(err) {
    dot.className      = 'cvdd-status-dot error';
    status.textContent = 'âŒ åŠ è½½å¤±è´¥ï¼šè¯·ç¡®è®¤ btc_history.csv åœ¨åŒä¸€æ–‡ä»¶å¤¹ï¼Œå¹¶é€šè¿‡ Python æœåŠ¡å™¨è®¿é—®';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å€’è®¡æ—¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tickCountdown() {
  var el = document.getElementById('countdown');
  el.textContent = secondsLeft <= 0 ? 'åˆ·æ–°ä¸­...' : secondsLeft + 's ååˆ·æ–°';
  if (secondsLeft > 0) secondsLeft--;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  å¯åŠ¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderNav('dashboard');

// æŠŠå€’è®¡æ—¶å¾½ç« æ³¨å…¥åˆ°å¯¼èˆªæ å³ä¾§
var badge = document.getElementById('nav-badge');
if (badge) {
  badge.innerHTML = '<div style="display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:11px;color:#5a5a7a"><div style="width:6px;height:6px;border-radius:50%;background:#26de81;animation:pulse 2s infinite"></div><span id="countdown">åˆ·æ–°ä¸­...</span></div>';
}

initKline();
loadKline('1w', null);
fetchPrice();
loadCVDD();

setInterval(fetchPrice, 60000);
setInterval(tickCountdown, 1000);
tickCountdown();
</script>
</body>
</html>
