<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>200 Week MA Heatmap â€” BTC Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="nav.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #1e1e2e;
    --gold: #f7b731;
    --gold-dim: #a07820;
    --green: #26de81;
    --red: #fc5c65;
    --blue: #74b9ff;
    --text: #e8e8f0;
    --muted: #5a5a7a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg); color: var(--text);
    font-family: 'Syne', sans-serif; min-height: 100vh; overflow-x: hidden;
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 999;
  }

  .main { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

  .page-title { margin-bottom: 28px; }
  .page-title h1 { font-size: 30px; font-weight: 800; margin-bottom: 8px; }
  .page-title h1 span { color: var(--gold); }
  .page-title p { font-size: 14px; color: var(--muted); line-height: 1.8; max-width: 700px; }
  .page-title p strong { color: var(--text); }

  /* stats */
  .stats-grid {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 14px; margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px 22px;
    position: relative; overflow: hidden;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; opacity: 0.8;
  }
  .stat-card.c-gold::before  { background: var(--gold); }
  .stat-card.c-blue::before  { background: var(--blue); }
  .stat-card.c-green::before { background: var(--green); }
  .stat-card.c-heat::before  { background: linear-gradient(90deg, #6c00ff, #0066ff, #00cc44, #ffaa00, #ff2200); }

  .stat-label {
    font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 8px;
  }
  .stat-value { font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace; }
  .stat-sub   { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 4px; }

  /* signal */
  .signal-badge {
    display: inline-flex; align-items: center; gap: 8px;
    font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700;
    padding: 8px 18px; border-radius: 8px; margin-bottom: 24px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  /* chart area */
  .chart-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; margin-bottom: 20px;
  }
  .chart-label {
    font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 16px;
  }
  #heatChart { width: 100%; height: 480px; display: block; }

  /* color scale legend */
  .colorscale-wrap {
    margin-top: 20px; display: flex; align-items: center; gap: 16px;
  }
  .colorscale-label {
    font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted);
    white-space: nowrap;
  }
  .colorscale-bar {
    flex: 1; height: 12px; border-radius: 6px;
    background: linear-gradient(90deg,
      #6c00ff 0%,
      #0066ff 20%,
      #00cc44 40%,
      #ffaa00 65%,
      #ff6600 80%,
      #ff2200 100%
    );
  }
  .colorscale-ticks {
    display: flex; justify-content: space-between;
    font-family: 'Space Mono', monospace; font-size: 10px;
    color: var(--muted); margin-top: 4px;
  }

  /* status */
  .status-bar {
    font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted);
    margin-bottom: 20px; display: flex; align-items: center; gap: 8px;
  }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; }
  .status-dot.loading { background: var(--gold); animation: pulse 1s infinite; }
  .status-dot.ready   { background: var(--green); }
  .status-dot.error   { background: var(--red); }
  @keyframes pulse {
    0%,100%{ opacity:1; transform:scale(1); }
    50%     { opacity:0.4; transform:scale(0.8); }
  }

  /* note */
  .note {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 20px;
    font-family: 'Space Mono', monospace; font-size: 11px;
    color: var(--muted); line-height: 1.9;
  }
  .note strong { color: var(--text); }

  @media (max-width: 900px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 600px) {
    .main { padding: 16px 20px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div id="nav-root"></div>

<div class="main">

  <div class="page-title">
    <h1>200 Week MA <span>Heatmap</span></h1>
    <p>
      ç”± <strong>Plan Bï¼ˆ@100trillionUSDï¼‰</strong> åˆ›å»ºã€‚
      ä»¥ <strong>1400å¤©ï¼ˆ200å‘¨ï¼‰ç§»åŠ¨å¹³å‡çº¿</strong> ä½œä¸ºé•¿æœŸåº•éƒ¨å‚è€ƒï¼Œ
      ç”¨<strong>é¢œè‰²çƒ­åŠ›å›¾</strong>è¡¨ç¤ºå‡çº¿çš„æœˆåº¦æ¶¨å¹…ï¼š
      ç´«è“è‰²ä»£è¡¨åº•éƒ¨ç§¯ç´¯åŒºï¼Œæ©™çº¢è‰²ä»£è¡¨é¡¶éƒ¨è¿‡çƒ­åŒºã€‚
      å†å²ä¸Šä»·æ ¼ä»æœªåœ¨200å‘¨å‡çº¿ä»¥ä¸‹æ”¶ç›˜è¶…è¿‡ä¸€ä¸ªæœˆã€‚
    </p>
  </div>

  <!-- Signal badge -->
  <div class="signal-badge" id="signalBadge" style="background:rgba(108,0,255,0.1);color:#a78bfa">
    â³ è®¡ç®—ä¸­...
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card c-gold">
      <div class="stat-label">å½“å‰ BTC ä»·æ ¼</div>
      <div class="stat-value" id="s-price" style="color:var(--gold)">--</div>
    </div>
    <div class="stat-card c-blue">
      <div class="stat-label">200å‘¨å‡çº¿ï¼ˆ1400å¤©ï¼‰</div>
      <div class="stat-value" id="s-ma200" style="color:var(--blue)">--</div>
      <div class="stat-sub" id="s-ma-dist">è·å‡çº¿ --</div>
    </div>
    <div class="stat-card c-green">
      <div class="stat-label">å‡çº¿æœˆåº¦æ¶¨å¹…</div>
      <div class="stat-value" id="s-pct" style="color:var(--green)">--</div>
      <div class="stat-sub">ä¸4å‘¨å‰ç›¸æ¯”</div>
    </div>
    <div class="stat-card c-heat">
      <div class="stat-label">å½“å‰çƒ­åŠ›é¢œè‰²</div>
      <div id="s-colorbox" style="width:48px;height:28px;border-radius:6px;margin:4px 0;background:#6c00ff"></div>
      <div class="stat-sub" id="s-colorlabel">è®¡ç®—ä¸­...</div>
    </div>
  </div>

  <!-- Status -->
  <div class="status-bar">
    <div class="status-dot loading" id="statusDot"></div>
    <span id="statusText">æ­£åœ¨åŠ è½½æ•°æ®...</span>
  </div>

  <!-- Chart -->
  <div class="chart-wrap">
    <div class="chart-label">BTC ä»·æ ¼çƒ­åŠ›å›¾ + 200å‘¨å‡çº¿ï¼ˆå¯¹æ•°åæ ‡ï¼‰</div>
    <canvas id="heatChart"></canvas>

    <!-- Color scale -->
    <div class="colorscale-wrap">
      <div class="colorscale-label">å†·ï¼ˆå‡çº¿æ¶¨å¹…ä½ï¼‰</div>
      <div>
        <div class="colorscale-bar"></div>
        <div class="colorscale-ticks">
          <span>0%</span><span>5%</span><span>10%</span><span>20%</span><span>30%</span><span>40%+</span>
        </div>
      </div>
      <div class="colorscale-label">çƒ­ï¼ˆå‡çº¿æ¶¨å¹…é«˜ï¼‰</div>
    </div>
  </div>

  <div class="note">
    <strong>è®¡ç®—æ–¹æ³•ï¼š</strong>
    200å‘¨å‡çº¿ = è¿‡å»1400å¤©æ”¶ç›˜ä»·çš„ç®€å•ç§»åŠ¨å¹³å‡ï¼ˆSMA1400ï¼‰ã€‚
    çƒ­åŠ›é¢œè‰² = å½“å‰SMA1400 ä¸ 28å¤©å‰SMA1400 çš„æ¶¨å¹…ç™¾åˆ†æ¯”ï¼Œ
    æ¶¨å¹…è¶Šé«˜é¢œè‰²è¶Šçº¢ï¼Œæ¶¨å¹…è¶Šä½é¢œè‰²è¶Šç´«ã€‚<br>
    <strong>å†å²è§„å¾‹ï¼š</strong>æ©™çº¢åŒºé—´ï¼ˆå‡çº¿æœˆæ¶¨å¹… &gt; 20%ï¼‰å†å²ä¸Šå¯¹åº”ç‰›å¸‚é¡¶éƒ¨ï¼›
    ç´«è“åŒºé—´ï¼ˆå‡çº¿æœˆæ¶¨å¹… &lt; 5%ï¼‰å†å²ä¸Šå¯¹åº”ç†Šå¸‚åº•éƒ¨ã€‚<br>
    <strong>æ•°æ®æ¥æºï¼š</strong>æœ¬åœ° btc_history.csv + CoinGecko APIï¼ˆè¿‘365å¤©ï¼‰ï¼Œè‡ªåŠ¨åˆå¹¶å»é‡ã€‚<br>
    <strong>æ³¨æ„ï¼š</strong>å†å²è§„å¾‹ä¸ä»£è¡¨æœªæ¥ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
  </div>

</div>

<script>
renderNav('200wma');

var heatChart = null;

function setStatus(state, text) {
  document.getElementById('statusDot').className  = 'status-dot ' + state;
  document.getElementById('statusText').textContent = text;
}

// â”€â”€ å·¥å…·å‡½æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toDateStr(d) { return d.toISOString().substring(0, 10); }

function parseCSV(text) {
  var lines = text.trim().split('\n');
  var out = [];
  for (var i = 1; i < lines.length; i++) {
    var cols  = lines[i].split(',');
    var price = parseFloat(cols[1]);
    if (!price) continue;
    out.push({ dateStr: cols[0].substring(0,10), date: new Date(cols[0]), price: price });
  }
  return out;
}

function parseAPI(data) {
  var out = [];
  for (var i = 0; i < data.prices.length; i++) {
    var price = data.prices[i][1];
    if (!price) continue;
    var d = new Date(data.prices[i][0]);
    out.push({ dateStr: toDateStr(d), date: d, price: price });
  }
  return out;
}

function mergeAndSort(csv, api) {
  var apiDates = {};
  api.forEach(function(d) { apiDates[d.dateStr] = true; });
  var merged = csv.filter(function(d) { return !apiDates[d.dateStr]; }).concat(api);
  merged.sort(function(a, b) { return a.date - b.date; });
  return merged;
}

// â”€â”€ æ ¸å¿ƒè®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// 1. SMA1400 = è¿‡å»1400å¤©å‡å€¼ï¼ˆ200å‘¨å‡çº¿ï¼‰
// 2. pct     = (SMA1400_ä»Šå¤© - SMA1400_28å¤©å‰) / SMA1400_28å¤©å‰ Ã— 100
//              å³å‡çº¿çš„æœˆåº¦æ¶¨å¹…ç™¾åˆ†æ¯”
// 3. color   = æ ¹æ®pctæ˜ å°„åˆ°è‰²é˜¶

var MA_WINDOW = 1400;  // 200å‘¨ = 1400å¤©
var PCT_WINDOW = 28;   // 4å‘¨ = 28å¤©ï¼ˆæœˆåº¦æ¯”è¾ƒï¼‰

function calcMA200(days) {
  // å…ˆç®—SMA1400
  for (var i = 0; i < days.length; i++) {
    if (i < MA_WINDOW - 1) {
      days[i].ma200 = null;
    } else {
      var sum = 0;
      for (var j = i - MA_WINDOW + 1; j <= i; j++) sum += days[j].price;
      days[i].ma200 = sum / MA_WINDOW;
    }
  }

  // å†ç®—æœˆåº¦æ¶¨å¹… pct
  for (var i = 0; i < days.length; i++) {
    if (days[i].ma200 === null) {
      days[i].pct = null;
      continue;
    }
    var prev = i - PCT_WINDOW;
    if (prev < 0 || days[prev].ma200 === null) {
      days[i].pct = null;
    } else {
      days[i].pct = (days[i].ma200 - days[prev].ma200) / days[prev].ma200 * 100;
    }
  }
  return days;
}

// â”€â”€ é¢œè‰²æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// pct â†’ RGBé¢œè‰²
// è‰²é˜¶ï¼šç´«è‰²(0%) â†’ è“è‰²(5%) â†’ ç»¿è‰²(10%) â†’ é»„è‰²(20%) â†’ æ©™è‰²(30%) â†’ çº¢è‰²(40%+)
//
// å®ç°æ–¹å¼ï¼šå®šä¹‰å‡ ä¸ªå…³é”®é¢œè‰²èŠ‚ç‚¹ï¼Œpctä»‹äºä¸¤èŠ‚ç‚¹ä¹‹é—´æ—¶çº¿æ€§æ’å€¼

var COLOR_STOPS = [
  { pct:  0, r: 108, g:   0, b: 255 },  // ç´«è‰²  â€” åº•éƒ¨å†·åŒº
  { pct:  5, r:   0, g: 102, b: 255 },  // è“è‰²
  { pct: 10, r:   0, g: 204, b:  68 },  // ç»¿è‰²
  { pct: 20, r: 255, g: 170, b:   0 },  // é»„è‰²
  { pct: 30, r: 255, g: 102, b:   0 },  // æ©™è‰²
  { pct: 40, r: 255, g:  34, b:   0 },  // çº¢è‰²  â€” é¡¶éƒ¨çƒ­åŒº
];

function pctToColor(pct, alpha) {
  if (pct === null) return 'rgba(90,90,122,' + (alpha||1) + ')';

  // è¶…å‡ºèŒƒå›´æ—¶æˆªæ–­
  var p = Math.max(0, Math.min(40, pct));

  // æ‰¾æ‰€åœ¨çš„åŒºé—´
  var lo = COLOR_STOPS[0];
  var hi = COLOR_STOPS[COLOR_STOPS.length - 1];
  for (var i = 0; i < COLOR_STOPS.length - 1; i++) {
    if (p >= COLOR_STOPS[i].pct && p <= COLOR_STOPS[i+1].pct) {
      lo = COLOR_STOPS[i];
      hi = COLOR_STOPS[i+1];
      break;
    }
  }

  // çº¿æ€§æ’å€¼
  var t = (lo.pct === hi.pct) ? 0 : (p - lo.pct) / (hi.pct - lo.pct);
  var r = Math.round(lo.r + (hi.r - lo.r) * t);
  var g = Math.round(lo.g + (hi.g - lo.g) * t);
  var b = Math.round(lo.b + (hi.b - lo.b) * t);
  return 'rgba(' + r + ',' + g + ',' + b + ',' + (alpha||1) + ')';
}

function colorLabel(pct) {
  if (pct === null) return 'æ•°æ®ä¸è¶³';
  if (pct <  5)  return 'ğŸŸ£ ç´«è‰²åŒº â€” æ·±åº¦åº•éƒ¨';
  if (pct < 10)  return 'ğŸ”µ è“è‰²åŒº â€” åº•éƒ¨ç§¯ç´¯';
  if (pct < 20)  return 'ğŸŸ¢ ç»¿è‰²åŒº â€” æ­£å¸¸ä¸Šå‡';
  if (pct < 30)  return 'ğŸŸ¡ é»„è‰²åŒº â€” å¸‚åœºè¿‡çƒ­';
  if (pct < 40)  return 'ğŸŸ  æ©™è‰²åŒº â€” æ¥è¿‘é¡¶éƒ¨';
  return              'ğŸ”´ çº¢è‰²åŒº â€” å†å²é¡¶éƒ¨åŒº';
}

// â”€â”€ æ›´æ–°ç»Ÿè®¡å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(days) {
  var latest = days[days.length - 1];
  var price  = latest.price;
  var ma     = latest.ma200;
  var pct    = latest.pct;

  document.getElementById('s-price').textContent =
    '$' + price.toLocaleString('en-US', {maximumFractionDigits: 0});

  if (ma) {
    document.getElementById('s-ma200').textContent =
      '$' + ma.toLocaleString('en-US', {maximumFractionDigits: 0});
    var dist = ((price - ma) / ma * 100).toFixed(1);
    document.getElementById('s-ma-dist').textContent =
      (dist >= 0 ? 'é«˜äºå‡çº¿ +' : 'ä½äºå‡çº¿ ') + dist + '%';
  }

  if (pct !== null) {
    document.getElementById('s-pct').textContent = '+' + pct.toFixed(2) + '%';
    document.getElementById('s-pct').style.color = pctToColor(pct);
    document.getElementById('s-colorbox').style.background = pctToColor(pct);
    document.getElementById('s-colorlabel').textContent = colorLabel(pct);
  }

  // ä¿¡å·å¾½ç« 
  var badge = document.getElementById('signalBadge');
  var color = pctToColor(pct);
  var label = colorLabel(pct);
  badge.style.background = pctToColor(pct, 0.12);
  badge.style.color      = color;
  badge.style.borderColor = pctToColor(pct, 0.3);
  badge.textContent      = label;
}

// â”€â”€ ç”»å›¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// çƒ­åŠ›å›¾ç”¨ã€Œæ•£ç‚¹å›¾ã€å®ç°ï¼š
// æ¯ä¸ªæ•°æ®ç‚¹ = ä¸€ä¸ªå°åœ†ç‚¹ï¼Œé¢œè‰²æ ¹æ®pctåŠ¨æ€è®¾ç½®
// 200å‘¨å‡çº¿å•ç‹¬ç”»ä¸€æ¡ç™½è‰²çº¿

function drawChart(days) {
  // åªå– pct ä¸ä¸º null çš„å¤©ï¼ˆä»ç¬¬1400+28å¤©èµ·ï¼‰
  var valid = days.filter(function(d) { return d.pct !== null; });

  // æ•£ç‚¹å›¾æ•°æ®ï¼šæ¯ä¸ªç‚¹çš„é¢œè‰²å•ç‹¬è®¾ç½®
  var scatterData = valid.map(function(d) {
    return { x: d.date, y: d.price };
  });
  var pointColors = valid.map(function(d) {
    return pctToColor(d.pct, 0.9);
  });

  // 200å‘¨å‡çº¿æ•°æ®
  var maData = valid.map(function(d) {
    return { x: d.date, y: Math.round(d.ma200) };
  });

  if (heatChart) heatChart.destroy();

  var ctx = document.getElementById('heatChart').getContext('2d');
  heatChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          // çƒ­åŠ›æ•£ç‚¹ï¼šä»·æ ¼ç‚¹ï¼Œé¢œè‰²=çƒ­åŠ›è‰²
          label: 'BTC ä»·æ ¼ï¼ˆçƒ­åŠ›è‰²ï¼‰',
          data: scatterData,
          pointBackgroundColor: pointColors,
          pointBorderColor:     pointColors,
          pointRadius: 2.5,
          pointHoverRadius: 5,
          type: 'scatter',
          yAxisID: 'y',
        },
        {
          // 200å‘¨å‡çº¿ï¼šç™½è‰²å®çº¿
          label: '200å‘¨å‡çº¿ï¼ˆ1400å¤©ï¼‰',
          data: maData,
          type: 'line',
          borderColor: 'rgba(255,255,255,0.7)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.2,
          yAxisID: 'y',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#e8e8f0',
            font: { family: 'Space Mono, monospace', size: 12 },
            boxWidth: 24, padding: 20,
            // æ•£ç‚¹å›¾çš„å›¾ä¾‹ç”¨åœ†ç‚¹è€Œä¸æ˜¯çº¿
            usePointStyle: true,
          }
        },
        tooltip: {
          backgroundColor: '#13131a',
          borderColor: '#1e1e2e',
          borderWidth: 1,
          titleColor: '#5a5a7a',
          bodyColor: '#e8e8f0',
          callbacks: {
            title: function(items) {
              return new Date(items[0].parsed.x).toLocaleDateString('zh-CN');
            },
            label: function(ctx) {
              if (ctx.datasetIndex === 0) {
                // æ‰¾åˆ°å¯¹åº”å¤©çš„pctå€¼
                var idx   = ctx.dataIndex;
                var d     = valid[idx];
                return [
                  ' ä»·æ ¼: $' + ctx.parsed.y.toLocaleString(),
                  ' å‡çº¿æœˆæ¶¨å¹…: +' + (d.pct ? d.pct.toFixed(2) : '--') + '%',
                  ' ' + colorLabel(d.pct),
                ];
              }
              return ' 200å‘¨å‡çº¿: $' + ctx.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year' },
          ticks: { color: '#5a5a7a', font: { family: 'Space Mono, monospace' } },
          grid:  { color: '#1e1e2e' },
        },
        y: {
          type: 'logarithmic',
          position: 'right',
          ticks: {
            color: '#5a5a7a',
            font: { family: 'Space Mono, monospace' },
            callback: function(v) {
              var neat = [100, 500, 1000, 5000, 10000, 50000, 100000];
              return neat.indexOf(v) >= 0 ? '$' + v.toLocaleString() : '';
            }
          },
          grid: { color: '#1e1e2e' },
        }
      }
    }
  });
}

// â”€â”€ ä¸»æµç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Promise.all([
  fetch('btc_history.csv').then(function(r) { return r.text(); }),
  fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365&interval=daily')
    .then(function(r) { return r.json(); })
])
.then(function(results) {
  setStatus('loading', 'è®¡ç®— 200å‘¨å‡çº¿ ä¸­ï¼ˆéœ€è¦1400å¤©æ•°æ®ï¼Œè¯·ç¨å€™ï¼‰...');
  var csv    = parseCSV(results[0]);
  var api    = parseAPI(results[1]);
  var merged = mergeAndSort(csv, api);
  var days   = calcMA200(merged);

  var validCount = days.filter(function(d) { return d.pct !== null; }).length;
  setStatus('ready', 'âœ… æ•°æ®å°±ç»ª â€” å…± ' + days.length + ' å¤©ï¼Œçƒ­åŠ›å›¾æœ‰æ•ˆæ•°æ® ' + validCount + ' å¤©');

  updateStats(days);
  drawChart(days);
})
.catch(function() {
  setStatus('error', 'âŒ åŠ è½½å¤±è´¥ï¼šè¯·ç¡®è®¤ btc_history.csv åœ¨åŒä¸€æ–‡ä»¶å¤¹ï¼Œå¹¶é€šè¿‡ Python æœåŠ¡å™¨è®¿é—®');
});
</script>
</body>
</html>
