<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CVDD â€” BTC Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="nav.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #13131a; --border: #1e1e2e;
    --gold: #f7b731; --green: #26de81; --red: #fc5c65;
    --purple: #a29bfe; --text: #e8e8f0; --muted: #5a5a7a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 999;
  }
  .main { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

  .page-title { margin-bottom: 28px; }
  .page-title h1 { font-size: 30px; font-weight: 800; margin-bottom: 8px; }
  .page-title h1 span { color: var(--gold); }
  .page-title p { font-size: 14px; color: var(--muted); line-height: 1.8; max-width: 700px; }
  .page-title p strong { color: var(--text); }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px 22px; position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
  .stat-card.c-gold::before   { background: var(--gold); }
  .stat-card.c-green::before  { background: var(--green); }
  .stat-card.c-purple::before { background: var(--purple); }
  .stat-card.c-muted::before  { background: var(--muted); }
  .stat-label { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 8px; }
  .stat-value { font-size: 20px; font-weight: 700; font-family: 'Space Mono', monospace; }
  .stat-sub   { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; margin-top: 4px; }

  .status-bar { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; }
  .status-dot.loading { background: var(--gold); animation: pulse 1s infinite; }
  .status-dot.ready   { background: var(--green); }
  .status-dot.error   { background: var(--red); }
  @keyframes pulse { 0%,100%{ opacity:1; transform:scale(1); } 50%{ opacity:0.4; transform:scale(0.8); } }

  .chart-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 20px; height: 520px; overflow: hidden; }
  .chart-label { font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 16px; }
  #cvddChart { width: 100%; height: 440px; display: block; }

  .note { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.9; }
  .note strong { color: var(--text); }

  @media (max-width: 900px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 600px) { .main { padding: 16px 20px; } }
</style>
</head>
<body>

<div id="nav-root"></div>

<div class="main">
  <div class="page-title">
    <h1>è¿‘ä¼¼ <span>CVDD</span></h1>
    <p>
      ç”±é“¾ä¸Šåˆ†æå¸ˆ <strong>Willy Woo</strong> åˆ›å»ºçš„åº•éƒ¨åˆ¤æ–­æŒ‡æ ‡ã€‚
      æœ¬é¡µå›¾è¡¨ä½¿ç”¨ <strong>CoinGecko å…¬å¼€æ•°æ® + æœ¬åœ°CSV</strong> è‡ªè¡Œè®¡ç®—ï¼Œ
      æ•°æ®å®Œå…¨é€æ˜ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹å›¾è¡¨æœåŠ¡ã€‚
      å†å²ä¸Š CVDD æ›¾å¤šæ¬¡è§¦ç¢°æ¯”ç‰¹å¸<strong>å‘¨æœŸåº•éƒ¨</strong>ï¼Œå¯ä½œä¸ºé•¿çº¿å‚è€ƒã€‚
    </p>
  </div>

  <div class="stats-grid">
    <div class="stat-card c-gold">
      <div class="stat-label">å½“å‰ BTC ä»·æ ¼</div>
      <div class="stat-value" id="cvdd-price" style="color:var(--gold)">--</div>
    </div>
    <div class="stat-card c-green">
      <div class="stat-label">è¿‘ä¼¼ CVDD</div>
      <div class="stat-value" id="cvdd-value" style="color:var(--green)">--</div>
      <div class="stat-sub">åº•éƒ¨å‚è€ƒçº¿</div>
    </div>
    <div class="stat-card c-purple">
      <div class="stat-label">ä»·æ ¼ / CVDD æ¯”å€¼</div>
      <div class="stat-value" id="cvdd-ratio" style="color:var(--purple)">--</div>
      <div class="stat-sub" id="cvdd-interp">--</div>
    </div>
    <div class="stat-card c-muted">
      <div class="stat-label">æ•°æ®è¦†ç›–</div>
      <div class="stat-value" id="cvdd-days" style="font-size:16px;color:var(--text)">--</div>
      <div class="stat-sub" id="cvdd-range">--</div>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-dot loading" id="cvddDot"></div>
    <span id="cvddStatus">æ­£åœ¨åŠ è½½ CSV + API æ•°æ®...</span>
  </div>

  <div class="chart-wrap">
    <div class="chart-label">BTC ä»·æ ¼ + è¿‘ä¼¼ CVDD + ä¹°å…¥å‚è€ƒåŒºé—´</div>
    <canvas id="cvddChart"></canvas>
  </div>

  <div class="note">
    <strong>æ•°æ®æ¥æºï¼š</strong>å†å²éƒ¨åˆ†æ¥è‡ªæœ¬åœ° btc_history.csvï¼ˆCoinGecko ä¸‹è½½ï¼‰ï¼Œ
    è¿‘ä¸€å¹´æ•°æ®ç”± CoinGecko API å®æ—¶è¡¥å……ï¼Œä¸¤è€…è‡ªåŠ¨åˆå¹¶å»é‡ã€‚<br>
    <strong>è®¡ç®—æ–¹æ³•ï¼š</strong>å¯¹æ•°æ ‡å‡†åŒ–æˆäº¤é‡ &times; å½“æ—¥ä»·æ ¼ï¼Œç´¯è®¡æ±‚å’Œåé™¤ä»¥å¤©æ•°ï¼Œä¹˜ä»¥æ ¡å‡†ç³»æ•° 2.02ã€‚<br>
    <strong>ä¹°å…¥å‚è€ƒåŒºé—´ï¼š</strong>é»„è‰²ä¸Šæ²¿ = CVDD &times; 1.7ï¼Œç»¿è‰²ä¸‹æ²¿ = CVDD &times; 1.0ã€‚
    ç³»æ•°æ¥è‡ªå››ä¸ªå†å²åº•éƒ¨ï¼ˆ2015 / 2018 / 2020 / 2022ï¼‰çš„å®æµ‹æ¯”å€¼ï¼Œè¿›å…¥åŒºé—´ä¸ä»£è¡¨ç«‹å³åå¼¹ï¼Œå»ºè®®åˆ†æ‰¹æ“ä½œã€‚<br>
    <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯è¿‘ä¼¼ç®—æ³•ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
  </div>
</div>

<script>
renderNav('cvdd');

var cvddChart  = null;
var CVDD_SMOOTH = 2.02;

var BOTTOMS = [
  { date: '2015-01-14', price: 170,   label: '2015 åº•éƒ¨\n$170'   },
  { date: '2018-12-15', price: 3200,  label: '2018 åº•éƒ¨\n$3,200' },
  { date: '2020-03-13', price: 4000,  label: '2020 åº•éƒ¨\n$4,000' },
  { date: '2022-11-21', price: 15500, label: '2022 åº•éƒ¨\n$15,500'},
];

function toDateStr(d) { return d.toISOString().substring(0, 10); }

function parseCSV(text) {
  var lines = text.trim().split('\n'), result = [];
  for (var i = 1; i < lines.length; i++) {
    var line   = lines[i].replace('\r', '');
    var cols   = line.split(',');
    var price  = parseFloat(cols[1]);
    var volume = parseFloat(cols[3]);
    if (!price || !volume || volume === 0) continue;
    result.push({ dateStr: cols[0].substring(0,10), date: new Date(cols[0]), price: price, volume: volume });
  }
  return result;
}

function parseAPI(data) {
  var prices = data.prices, volumes = data.total_volumes, result = [];
  for (var i = 0; i < prices.length; i++) {
    var price = prices[i][1], volume = volumes[i][1];
    if (!price || !volume || volume === 0) continue;
    var d = new Date(prices[i][0]);
    result.push({ dateStr: toDateStr(d), date: d, price: price, volume: volume });
  }
  return result;
}

function mergeAndSort(csv, api) {
  var apiDates = {};
  api.forEach(function(d) { apiDates[d.dateStr] = true; });
  var merged = csv.filter(function(d) { return !apiDates[d.dateStr]; }).concat(api);
  merged.sort(function(a, b) { return a.date - b.date; });
  return merged;
}

function calcCVDD(days) {
  for (var i = 0; i < days.length; i++) {
    days[i].btcVol = days[i].volume / days[i].price;
    days[i].logVol = Math.log(days[i].btcVol);
  }
  var minLog = Infinity, maxLog = -Infinity;
  for (var i = 0; i < days.length; i++) {
    if (days[i].logVol < minLog) minLog = days[i].logVol;
    if (days[i].logVol > maxLog) maxLog = days[i].logVol;
  }
  var cumulative = 0;
  for (var i = 0; i < days.length; i++) {
    var norm = (days[i].logVol - minLog) / (maxLog - minLog);
    cumulative   += norm * days[i].price;
    days[i].cvdd  = (cumulative / (i + 1)) * CVDD_SMOOTH;
  }
  return days;
}

function updateStats(days) {
  var latest = days[days.length - 1];
  var ratio  = latest.price / latest.cvdd;
  var interp = ratio < 1.5 ? 'ğŸŸ¢ æ¥è¿‘å†å²åº•éƒ¨'
             : ratio < 3.0 ? 'ğŸŸ¡ å¤„äºä¸­é—´åŒºé—´'
             : ratio < 6.0 ? 'ğŸŸ  é«˜äºåº•éƒ¨å‚è€ƒçº¿'
             :                'ğŸ”´ æ˜æ˜¾é«˜äºåº•éƒ¨å‚è€ƒçº¿';
  document.getElementById('cvdd-price').textContent = '$' + latest.price.toLocaleString('en-US', {maximumFractionDigits:0});
  document.getElementById('cvdd-value').textContent = '$' + latest.cvdd.toLocaleString('en-US', {maximumFractionDigits:0});
  document.getElementById('cvdd-ratio').textContent  = ratio.toFixed(2) + 'x';
  document.getElementById('cvdd-interp').textContent = interp;
  document.getElementById('cvdd-days').textContent   = days.length + ' å¤©';
  document.getElementById('cvdd-range').textContent  = days[0].date.getFullYear() + ' â†’ ' + latest.date.getFullYear();
}

function drawChart(days) {
  var annotations = {};
  BOTTOMS.forEach(function(b, i) {
    var ts = new Date(b.date).getTime();
    annotations['line'+i]  = { type:'line', xMin:ts, xMax:ts, borderColor:'rgba(252,92,101,0.5)', borderWidth:1, borderDash:[4,4] };
    annotations['point'+i] = { type:'point', xValue:ts, yValue:b.price, backgroundColor:'#fc5c65', borderColor:'#fff', borderWidth:1.5, radius:5 };
    annotations['label'+i] = { type:'label', xValue:ts, yValue:b.price, content:b.label.split('\n'), color:'#fc5c65', font:{family:'Space Mono,monospace',size:10,weight:'bold'}, textAlign:'center', yAdjust:(i%2===0)?-48:-80, callout:{enabled:true,borderColor:'rgba(252,92,101,0.4)',borderWidth:1} };
  });

  if (cvddChart) cvddChart.destroy();
  var ctx = document.getElementById('cvddChart').getContext('2d');
  cvddChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        { label:'BTC ä»·æ ¼', data:days.map(function(d){return{x:d.date,y:Math.round(d.price)};}), borderColor:'#f7b731', backgroundColor:'rgba(247,183,49,0.05)', borderWidth:1.5, pointRadius:0, tension:0.1, fill:false, yAxisID:'y' },
        { label:'è¿‘ä¼¼ CVDDï¼ˆåº•éƒ¨å‚è€ƒï¼‰', data:days.map(function(d){return{x:d.date,y:Math.round(d.cvdd)};}), borderColor:'#26de81', backgroundColor:'rgba(38,222,129,0.08)', borderWidth:2, pointRadius:0, tension:0.3, borderDash:[6,3], fill:false, yAxisID:'y' },
        { label:'ä¹°å…¥åŒºé—´ä¸Šæ²¿ï¼ˆCVDD Ã— 1.7ï¼‰', data:days.map(function(d){return{x:d.date,y:Math.round(d.cvdd*1.7)};}), borderColor:'rgba(252,185,0,0.6)', backgroundColor:'rgba(252,185,0,0.07)', borderWidth:1.5, pointRadius:0, tension:0.3, borderDash:[3,3], fill:'+1', yAxisID:'y' },
        { label:'ä¹°å…¥åŒºé—´ä¸‹æ²¿ï¼ˆCVDD Ã— 1.0ï¼‰', data:days.map(function(d){return{x:d.date,y:Math.round(d.cvdd*1.0)};}), borderColor:'rgba(38,222,129,0.4)', backgroundColor:'rgba(38,222,129,0.07)', borderWidth:1.5, pointRadius:0, tension:0.3, borderDash:[3,3], fill:false, yAxisID:'y' },
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      plugins: {
        legend:{ labels:{ color:'#e8e8f0', font:{family:'Space Mono,monospace',size:12}, boxWidth:24, padding:20 } },
        tooltip:{ backgroundColor:'#13131a', borderColor:'#1e1e2e', borderWidth:1, titleColor:'#5a5a7a', bodyColor:'#e8e8f0',
          callbacks:{
            title:function(items){ return new Date(items[0].parsed.x).toLocaleDateString('zh-CN'); },
            label:function(ctx){ if(ctx.datasetIndex===2||ctx.datasetIndex===3)return null; return ' '+ctx.dataset.label+': $'+ctx.parsed.y.toLocaleString(); }
          }
        },
        annotation:{ annotations:annotations }
      },
      scales:{
        x:{ type:'time', time:{unit:'year'}, ticks:{color:'#5a5a7a',font:{family:'Space Mono,monospace'}}, grid:{color:'#1e1e2e'} },
        y:{ type:'logarithmic', position:'right', ticks:{color:'#5a5a7a',font:{family:'Space Mono,monospace'},callback:function(v){var n=[100,500,1000,5000,10000,50000,100000];return n.indexOf(v)>=0?'$'+v.toLocaleString():'';}}, grid:{color:'#1e1e2e'} }
      }
    }
  });
}

// ä¸»æµç¨‹
var dot    = document.getElementById('cvddDot');
var status = document.getElementById('cvddStatus');

Promise.all([
  fetch('https://caroljx.github.io/btc-dashboard/btc_history.csv').then(function(r){return r.text();}),
  fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365&interval=daily').then(function(r){return r.json();})
])
.then(function(results) {
  status.textContent = 'è®¡ç®— CVDD ä¸­...';
  var csv    = parseCSV(results[0]);
  var api    = parseAPI(results[1]);
  var merged = mergeAndSort(csv, api);
  var days   = calcCVDD(merged);
  dot.className      = 'status-dot ready';
  status.textContent = 'âœ… æ•°æ®å°±ç»ª â€” CSV ' + csv.length + ' å¤© + API ' + api.length + ' å¤©ï¼Œåˆå¹¶åå…± ' + days.length + ' å¤©';
  updateStats(days);
  drawChart(days);
})
.catch(function(err) {
  dot.className      = 'status-dot error';
  status.textContent = 'âŒ åŠ è½½å¤±è´¥ï¼š' + err.message;
});
</script>
</body>
</html>
